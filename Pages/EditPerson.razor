@page "/EditPerson/{id:int}"
@using Newtonsoft.Json
@using System.Text
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Редактировать историческую личность</PageTitle>

<h1>Редактировать историческую личность</h1>

<div>
    <label for="name">Имя:</label>
    <input type="text" id="name" @bind="person.Name" />

    <label for="description">Описание:</label>
    <textarea id="description" @bind="person.Description"></textarea>

    <label for="dateOfBirth">Дата рождения:</label>
    <input type="date" id="dateOfBirth" @bind="person.DateOfBirth" />

    <label for="dateOfDeath">Дата смерти:</label>
    <input type="date" id="dateOfDeath" @bind="person.DateOfDeath" />

    <label for="timePeriodId">Исторический период:</label>
    <select id="timePeriodId" @bind="person.TimePeriodName">
        <option value="">Выберите период</option>
        @foreach (var period in TimePeriods)
        {
            <option value="@period.id">@period.name</option>
        }
    </select>
     <h4>Ссылки на дополнительные материалы</h4>
    <button type="button" @onclick="AddUrl">Добавить ссылку</button>
    <ul>
        @foreach (var url in person.Urls)
        {
            <li>
                <InputText @bind-Value="url.Name" placeholder="Название ссылки" />
                <InputText @bind-Value="url.Url" placeholder="URL" />
                <button type="button" @onclick="() => RemoveUrl(url)">Удалить</button>
            </li>
        }
    </ul>

    <h4>Регионы</h4>
    <InputSelect @bind-Value="selectedRegionId" @onchange="OnRegionChange">
        <option value="">Выберите регион</option>
        @foreach (var region in availableRegions)
        {
            <option value="@region.id">@region.name</option>
        }
    </InputSelect>
    <button type="button" @onclick="AddRegion">Добавить регион</button>
    <ul>
        @foreach (var region in person.Regions)
        {
            <li>
                @region.name
                <button type="button" @onclick="() => RemoveRegion(region)">Удалить</button>
            </li>
        }
    </ul>
    <button class="btn btn-primary" @onclick="UpdatePerson">Обновить</button>
    <button class="btn btn-secondary" @onclick="NavigateBack">Назад</button>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private PersonResponceModel person = new PersonResponceModel{
        Urls = new List<Urls>(),
        Regions = new List<iIdName>()
    };
    private List<iIdName> TimePeriods = new List<iIdName>();
    private List<iIdName> availableRegions = new List<iIdName>();
    private int? selectedRegionId;

    protected override async Task OnInitializedAsync()
    {  availableRegions = await GetRegions();
        await LoadTimePeriods();
        await LoadPerson();
    }

    private async Task LoadTimePeriods()
    {
        var response = await Http.GetAsync("https://localhost:7019/Spr/GetHistoryPeriods");
        if (response.IsSuccessStatusCode)
        {
            var body = await response.Content.ReadAsStringAsync();
            var responce = JsonConvert.DeserializeObject<SprResponceModel>(body);
            TimePeriods = responce.data.Select(e => new iIdName { id = e.Key, name = e.Value }).ToList();
        }
    }
    private async Task<List<iIdName>> GetRegions()
    {
        var response = await Http.GetAsync("https://localhost:7019/Spr/GetRegions");
        if (response.IsSuccessStatusCode)
        {
            var json = await response.Content.ReadAsStringAsync();
            var responce = JsonConvert.DeserializeObject<SprResponceModel>(json);
            return   responce.data.Select(e => new iIdName { id = e.Key, name = e.Value }).ToList(); 
        }
        return new List<iIdName>();
    }
     private void AddUrl()
    {
        person.Urls.Add(new Urls());
    }

    private void RemoveUrl(Urls url)
    {
        person.Urls.Remove(url);
    }

    private void AddRegion()
    {
        if (selectedRegionId.HasValue)
        {
            var regionToAdd = availableRegions.FirstOrDefault(r => r.id == selectedRegionId);
            if (regionToAdd != null && !person.Regions.Any(r => r.id == regionToAdd.id))
            {person.Regions.Add(regionToAdd);
            }
        }
    }

    private void RemoveRegion(iIdName region)
    {
        person.Regions.Remove(region);
    }

    private void OnRegionChange(ChangeEventArgs e)
    {
        selectedRegionId = int.TryParse(e.Value.ToString(), out var id) ? id : (int?)null;
    }

    private async Task LoadPerson()
    {
        var response = await Http.GetAsync($"https://localhost:7019/HistoryPersons/Get/{Id}");
        if (response.IsSuccessStatusCode)
        {
            var body = await response.Content.ReadAsStringAsync();
                  
 var responseModel = JsonConvert.DeserializeObject<PersonMassResponceModel>(body);
        person = responseModel.data;

        }
    }

    private async Task UpdatePerson()
    {
        var model = JsonConvert.SerializeObject(person);
        var data = new StringContent(model, Encoding.UTF8, "application/json");
        var response = await Http.PutAsync($"https://localhost:7019/HistoryPersons/Update/{Id}", data);
        
        if (response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("/HistoryPersons");
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/HistoryPersons");
    }

     
}